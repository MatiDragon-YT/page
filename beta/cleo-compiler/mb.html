<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Compilador de mods</title>
	<link rel="stylesheet" href="https://matidragon-yt.github.io/page/css/main.css">
</head>
<body style="display: block;">
<div class="green"></div>
<div style="margin: 1em;">
<style>
.contador {
    counter-increment: listing;
    color: grey;
    width: 3.5em;
    position: relative;
    display: inline-block;
}
.contador::before {
    content: counter(listing, decimal-leading-zero);
}
.treeLine {
    border-left: dotted 1px #494949;
    height: 1.46rem;
    position: absolute;
}
</style>
<script>

const D = document

//const SP = String.prototype
//const EP = Element.prototype

NodeList.prototype.forEach = Array.prototype.forEach

/** Smart selector for elements of the DOM
 * @param {DOMString}
 * @param {Element} optional
 * @return {Element}
*/
function $(element, _parent) {
	_parent = _parent || D
	const xElements = _parent.querySelectorAll(element)
	const length = xElements.length

	if (element.charAt(0) === '#' && !/\s/.test(element) || length === 1) { 
		return _parent.querySelector(element);
	}
	else {
		if(length === 0){return undefined}
		return xElements;
	}
}

/** Shotcun of String.replace()
*/
String.prototype.r = function(text, _text, _flags){
	_text = _text || ''
	_flags = _flags || ''
	return this.replace(text, _text, _flags)
}

/** Polifill and shotcun of String.replaceAll()
*/
String.prototype.rA = function(text, _text){
	var temp = this
	_text = _text || ''

	if(temp.indexOf(text, 0) !== -1){
		temp = temp
		.r(text, _text)
		.rA(text, _text)
	}
	
	return temp
}

/** Apply a function to all elements of the DOM
 * @param {NodeList} 
 * @param {function}
*/
function apply(element, callback){
	if(element){
		if('' + element == '[object NodeList]'){ 
			element.forEach(function(e){
				callback(e)
			})
		}else{  
			callback(element)
		}
	}
}
</script>

<form id="FORMULARIO">

	<input type="text" id="FILENAME" placeholder="File name" autocomplete="off" value="newScript.csi">
	<textarea id="HEX" autocomplete="off" class="w-100 m-0" placeholder="write your hex" spellcheck="false" style="
    position: absolute;
    display: block;
    width: calc(100% - 2em);
    color: transparent;
    background: transparent;
    caret-color: white;
    resize: none;
    padding: 4px 4px 4px 4.2em !important;
    margin: 0.6rem 0px;
    overflow: auto;
    max-height: 50vh;
    font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    line-height: 1.5em;
    font-size: 1rem!important;
    height: 50vh;
    ">
nop
:example
create_thread 'example'
    wait 0 {ms}
    camera_shake 100 {ms}
    0001: {wait} 1000 {ms}
    0003: {camera_shake} 100 {ms}
end_thread

set_lvar_float 0@ {=} 0.12</textarea>
	<pre id='PREVIEW' style="
	height: 50vh;
	font-size: 1rem!important;
	" class="m-0"></pre>

	<input type="text" id="" placeholder="hex's output" name="cleaned_hex" disabled class="w-100"><br><br>

	<!--<input type="checkbox" id="CHBSEPARATOR" checked="checked">Remover "0x" de los grupos de entrada<br><br>-->

	<a id="" class="button" onclick="Convert()" style="
    cursor: pointer;">compilar</a><br><br>

</form>

<blockquote>
<h5>IMPORTANTE!</h5>
La base de cmd(comandos) por ahora esta limitada a la que ve y son las primeras palabras con las que empiezan cada linea:<br>
 - <code>create_thread %short%</code>: Le da nombre al script, con un maximo con 7 letras dentro de las comillas simples.<br>
 - <code>nop</code>: Literal no hace nada, solo por si no queremos darle nombre al mod, usamos este comando.<br>
 - <code>wait %int%</code>: Frena la ejecucion del script por el numero de milesimas de segundos que asignemos.<br>
 - <code>camera_shake %int%</code>: Por un numero de milesimas de segundos que asignemos.<br>
 - <code>end_thread</code>: Cierra el mod para que no se conjele el juego.<br>
</blockquote>

<script src="compiler.js"></script>
<script type="text/javascript">
    function clean_hex(input, remove_0x) {
        input = input.toUpperCase();
        
        if (remove_0x) {
          input = input.replace(/0x/gi, "");        
        }
        
        let orig_input = input;
        input = input.replace(/[^A-Fa-f0-9]/g, "");
        // if (orig_input != input) alert ("E-01: Los caracteres no hexadecimales seran auto eliminados.");
        return input;    
    } 
    
    function Convert() {
    	if ($('#FILENAME').value.length == 0){
    		alert ("E-00: Añada un nombre al archivo.");
    		return
    	}

  		if(!$('#FILENAME').value.match(/\./)){
  			alert ("E-01: Añada una extencion al archivo.");
  			return
  		}

    	if ($('#HEX').value.length == 0){
    		alert ("E-02: Añada comandos al archivo.");
    		return
    	}

      let cleaned_hex = clean_hex($('#HEX').value.Translate(), true);
	  	let filename = $('#FILENAME').value;	  
      
      $('#FORMULARIO').cleaned_hex.value = cleaned_hex;
      
      if (cleaned_hex.length % 2) {
        alert ("E-03: la longitud de la cadena hexadecimal limpiada es impar.");     
        return;
      }

      let binary = new Array();
      for (let i=0; i<cleaned_hex.length/2; i++) {
        let h = cleaned_hex.substr(i*2, 2);
        binary[i] = parseInt(h,16);        
      }

		let byteArray = new Uint8Array(binary);
		let a = window.document.createElement('a');

		a.href = window.URL.createObjectURL(new Blob([byteArray], { type: 'application/octet-stream' }));
		a.download = filename;

		// Append anchor to body.
		document.body.appendChild(a)
		a.click();

		// Remove anchor from body
		document.body.removeChild(a)        
    } 

</script>

<script>
hl();
$('#HEX').oninput = hl

function hl(){
	const span = {
		start : "<span class=",
		end : ">$1<\/span>"
	}

	const enter = {
		comments  : span.start + "comments"   + span.end,
		numbers   : span.start + "numbers"    + span.end,
		variables : span.start + "variables"  + span.end,
		opcodes   : span.start + "opcodes"    + span.end,
		directives: span.start + "directives" + span.end,
		commands  : span.start + "commands"   + span.end,
		classes   : span.start + "classes"    + span.end
	}

	$('#PREVIEW').innerHTML = $('#HEX').value
	.r(/(^$)/gm, '$1 ')
	.r(/(\x20{4})/g, '<span class=treeLine><\/span>$1')
	//.rA('\t', '    ')
	.rA('&lt;br/&gt;', "\\n")
	.r(/(^.)/gm, '<span class=contador><\/span>$1')
	//Comentarios 
	.r(/(\/\/[^\n]+)/gm, enter.comments)
	.r(/(\/\*[^\/]*\*\/)/gmi, enter.comments)
	.r(/(\{[^\$][^\{\}]*\})/gmi, enter.comments)
	//Directivas
	.r(/(\{\$[^{}\n]+\})/gmi, enter.directives)
	//Cadenas de texto
	.r(/\"([^\n"]+)\"/gmi, '<span class=strings>"$1"<\/span>')
	.rA('\\"</span>', '\\"')
	.rA('\\"<span>', '\\"')
	.r(/\'([^\n']+)\'/gmi, "<span class=strings>'$1'<\/span>")
	.rA("\\'</span>", "\\'")
	.rA("\\'<span>", "\\'")
	//Palabras Reservadas
	.r(/([^\w\d])(longstring|shortstring|integer|thread|create_thread|create_custom_thread|end_thread|name_thread|end_thread_named|if and|if or|if|then|else|hex|end|else_jump|jump|jf|print|const|while|not|wait|repeat|until|break|continue|for|gosub|goto|var|array|to|downto|step|return|ret|rf|tr|Inc|Dec|Mul|Div|Alloc|Sqr|Random|int|string|float|bool|fade|DEFINE|nop|wasted_or_busted)($|[^\w\d])/gmi, "$1<span class=keywords>$2<\/span>$3")
	//Etiquetas
	.r(/([^\w\d])([@:])([\w\d]+)?/gm, "$1<span class=labels>$2$3<\/span>")
	.r(/([^\w\d])([A-Za-z0-9_]+\(\))/gm, "$1<span class=commands>$2<\/span>")
	//Arreglos
	.r(/(\[)([\d+]*)(\])/gmi, "$1<span class=numbers>$2<\/span>$3")
	//Opcodes
	.r(/([a-fA-F0-9]{4}\:)/gmi, enter.opcodes)
	//Variables ADMA
	.r(/((\&amp;)[\d\-abcdefx]+)/gim, enter.variables)
	//Variables globales
	.r(/((\x{00}|s|v)(\$[\d\w]+))/gm, enter.variables)
	//Numeros
	.r(/\b(\d+(x|\.)\w+)\b/gmi, enter.numbers)
	.r(/\b(true|false)\b/gmi, enter.numbers)
	.r(/(?!\#)(\W)(?!\$)(\d+)(?!\:|\@)([ifsv]?)\b/gmi, '$1<span class=numbers>$2$3<\/span>')
	//Modelos
	.r(/(\#[^\"\'\#\s]+)\b/gm, "<span class='models uppercase'>$1<\/span>")
	//Clases
	.r(/\b([a-z0-9]+)\.([a-z0-9]+)/gmi, "<span class=classes>$1</span>.<span class=commands>$2</span>")
	.r(/(\w+)(\(.+\)\.)(\w+)/gmi, "<span class=classes>$1</span>$2<span class=commands>$3</span>")
	.r(/(\$\w+|\d+\@)\.([0-9A-Z_a-z]+)/gm, "$1.<span class=commands>$2</span>")
	.r(/(:|of) (\w+)\n/gm,          "$1 <span class=classes>$2</span>\n")
	.r(/\.([0-9A-Z_a-z]+)\n/gm,"." + enter.commands +"\n")
	//Variables  
	.r(/\b(timer(a|b))\b/gmi, enter.variables)
	.r(/(\d+\@(s|v|\B)([^\w\d]|$))/gmi, enter.variables)
	// Operadores
	//.r(/\s(\.|\=|\+|\-|\*|\/|\%|\=\=|\+\=|\-\=|\*\=|\/\=|\%\=|\+\+|\-\-|\<|\>|\<\=|\>\=)\s/gmi," <font class=operador>$1<\/font> ")

	$('#PREVIEW').scrollTop = $('#HEX').scrollTop
	$('#PREVIEW').scrollLeft = $('#HEX').scrollLeft
}

$('#HEX').addEventListener("scroll", function(){
    $('#PREVIEW').scrollTop = $('#HEX').scrollTop
	$('#PREVIEW').scrollLeft = $('#HEX').scrollLeft
})
</script>

<style id="CSS"></style>
<script>
let tempCSS = ``

	const prefixes = ['-','-sm-','-md-','-lg-','-xl-','-xxl-']
	const size = [0,576,768,992,1200,1400]

	prefixes.forEach(function(prefix, resolucion){
		if (resolucion != 0) {tempCSS += '@media(min-width:' + size[resolucion] + 'px){'}
	
		var vIndex = 0
		while(vIndex < 13){
			tempCSS += '.cols'+prefix+vIndex+'{columns:'+vIndex+' auto}'

			vIndex++
		}
		
		[
			['m', 'margin'],
			['mt', 'margin-top'],
			['mb', 'margin-bottom'],
			['ml', 'margin-left'],
			['mr', 'margin-right'],
			['mx', 'margin-block'],
			['my', 'margin-inline'],
			['p', 'padding'],
			['pt', 'padding-top'],
			['pb', 'padding-bottom'],
			['pl', 'padding-left'],
			['pr', 'padding-right'],
			['px', 'padding-block'],
			['py', 'padding-inline'],
			['g', 'gap'],
			['r', 'border-radius']
		].forEach(function(attribute){
			[
				'0',
				'.25rem',
				'.5rem',
				'1rem',
				'1.5rem',
				'3rem'
			].forEach(function(value, index){
				tempCSS += '.' + attribute[0] + prefix + index + '{' + attribute[1]+ ':' + value + '!important}'
			})
		});

		[
			'auto',
			'8.33333333%',
			'16.66666667%',
			'25%',
			'33.33333333%',
			'41.66666667%',
			'50%',
			'58.33333333%',
			'66.66666667%',
			'75%',
			'83.33333333%',
			'91.66666667%',
			'100%'
		].forEach(function(value, index){
			tempCSS += '.col' + prefix + (index == 0 ? 'auto' : ++index) + '{width:' + value + '!important}'
			tempCSS += '.offset' + prefix + (index == 0 ? 'auto' : ++index) + '{margin-left:' + value + '!important}'
		});

		if (resolucion != 0) {tempCSS += '}\n\n'}
	})
$('#CSS').innerHTML = tempCSS
</script>
</body>
</html>