const log=t=>console.log(t),NP=Number.prototype,SP=String.prototype,AP=Array.prototype;function IsInRange(t,e,a){return e<=t&&t<=a?1:0}SP.r=function(t,e,a){return this.replace(t,e=e||"",a=a||"")},SP.rA=function(t,e){var a=this;return e=e||"",a=-1!==a.indexOf(t,0)?a.r(t,e).rA(t,e):a},SP.toBigEndian=function(){let e="";this.split(/([a-f0-9]{2})/i).clear().forEach(t=>e=t+e);return e},NP.toHex=function(){let a=new DataView(new ArrayBuffer(4)),t;return a.setFloat32(0,this),(t=Array.apply(null,{length:4}).map((t,e)=>("00"+a.getUint8(e).toString(16)).slice(-2)).join("")).toBigEndian()},AP.clear=function(){return this.forEach((t,e)=>{""==t&&this.splice(e,1)}),this};const TYPE_CODE={TERMINAL_NULL:"00",INT32:"01",GVAR:"02",LVAR:"03",INT8:"04",INT16:"05",FLOAT32:"06",GVAR_ARRAY_OFFSET:"07",LVAR_ARRAY_INDEX:"08",STRING8:"09",GVAR_STRING8:"0A",LVAR_STRING8:"0B",GVAR_ARRAY_STRING8:"0C",LVAR_ARRAY_STRING8:"0D",STRING_VARIABLE:"0E",STRING16:"0F",GVAR_STRING16:"10",LVAR_STRING16:"11",GVAR_ARRAY_STRING16:"12",LVAR_ARRAY_STRING16:"13"};let CUSTOM_VARIABLES=`
2=PLAYER_CHAR
3=PLAYER_ACTOR
11=PLAYER_GROUP
409=ONMISSION
`;(CUSTOM_VARIABLES=CUSTOM_VARIABLES.split("\n").clear()).forEach((t,e)=>{CUSTOM_VARIABLES[e]=t.split("=")});const SCM_DB={nop:{opcode:"0000",params:[]},wait:{opcode:"0001",params:["int"]},jump:{opcode:"0002",params:["label"]},camera_shake:{opcode:"0003",params:["int"]},set_var_int:{opcode:"0004",params:["gvar","int"]},set_var_float:{opcode:"0005",params:["gvar","float"]},set_lvar_int:{opcode:"0006",params:["lvar","int"]},set_lvar_float:{opcode:"0007",params:["lvar","float"]},add_val_to_int_var:{opcode:"0008",params:["gvar","int"]},add_val_to_float_var:{opcode:"0009",params:["gvar","float"]},create_thread:{opcode:"004f",params:["short"]},end_thread:{opcode:"004e",params:[]},"[short]":{opcode:"ffff",params:["short"]},"[long]":{opcode:"ffff",params:["long"]},"[string]":{opcode:"ffff",params:["string"]},"[int]":{opcode:"ffff",params:["int"]},"[float]":{opcode:"ffff",params:["float"]},"[lvar]":{opcode:"ffff",params:["lvar"]},"[gvar]":{opcode:"ffff",params:["gvar"]}};SP.toUnicode=function(){return this.split("").map(t=>""+t.charCodeAt(0).toString(16).padStart(2,"0")).join("")},SP.Translate=function(){let p=[],c=[];if(!this.match(/[^\w\d]("([^"\n]+)?)(\x20)(([^"\n]+)?")[^\w\d]/)){let n=this.r(/(\s+)?\/\/([^\n]+)?/gm,"").r(/(\s+)?\/\*([^\/]*)?\*\//gm,"").r(/(\s+)?\{([^\$\}]*)?\}/gm,"").r(/[\x20\t]+$/gm,"").r(/(\t|\x20)(\t|\x20)+/gm,"$1").r(/^[\x20\t]+/gm,"").r(/^\n+/gm,"").r(/\n$/gm,"").split("\n");this.split("\n").clear();n.forEach((r,o)=>{if(r.match(/^:/))c.push(r.r(":","").toUpperCase());else{n[o]=r.split(" ");let t=[],a="",e=!1,s="",l;n[o].forEach((t,e)=>{1<=e&&/(^[a-zA-Z]{2}|^[a-zA-Z]$|^[=/*+\-%^]$)/m.test(t)&&(n[o][e]=""),n[o]=n[o].clear()}),n[o].forEach((o,n)=>{if(0==n)o=o.toLowerCase(),/^[A-Fa-f\d]{4}:/m.test(o)?(a=o.r(":",""),/^[8-9A-Fa-f]/.test(o)&&(e=!0,a=(parseInt(a,16)-32768).toString(16).padStart(4,"0")),Object.entries(SCM_DB).every(([t,e])=>e.opcode!=a||(o=t,!1))):("!"==o[0]&&(o=o.r("!",""),e=!0),a=SCM_DB[o].opcode),1==e&&(a=(parseInt(a,16)+32768).toString(16)),t.push(a.toBigEndian()),s=o,c.push(2);else{switch(c.push(1),l=SCM_DB[s].params[--n]){case"short":c.push(9),o=(o=o.r(/'(.+)'/,"$1")).substring(0,7),o=(TYPE_CODE.STRING8+o.toUnicode()+"00").padEnd(20,"00");break;case"long":if((o=o.r(/"(.+)"/,"$1")).length<15)for(c.push(16),o=TYPE_CODE.STRING16+o.toUnicode()+"00";o.length<32;)o+=TYPE_CODE.TERMINAL_NULL;else o=o.substring(0,255),c.push(o.length),o=TYPE_CODE.STRING_VARIABLE+o.length+o.toUnicode();break;case"string":o=(o=o.r(/('(.+)'|"(.+)")/,"$2$3")).substring(0,255),c.push(o.length),o=TYPE_CODE.STRING_VARIABLE+o.length+o.toUnicode(),INPUT_CODE[i][index]=o;break;case"int":o=(o=(o=o.r(/^0x.+/im,t=>parseInt(t,16))).r("true",1)).r("false",0);let t=127;let e=32767;let a=2147483647;let r;if(0<=o)o<=a&&(r=TYPE_CODE.INT32),o<=e&&(r=TYPE_CODE.INT16),o<=t&&(r=TYPE_CODE.INT8);else{switch(IsInRange(o,-(t+=2),0)&&(r=TYPE_CODE.INT8),IsInRange(o,-(e+=2),-t)&&(r=TYPE_CODE.INT16),IsInRange(o,-(a+=2),-e)&&(r=TYPE_CODE.INT32),o*=-1,r){case TYPE_CODE.INT8:o-=255;break;case TYPE_CODE.INT16:o-=65535;break;case TYPE_CODE.INT32:o-=4294967295}o*=-1,o++}o=Number(o).toString(16).padStart((()=>{let t;switch(r){case TYPE_CODE.INT8:t=2,c.push(1);break;case TYPE_CODE.INT16:t=4,c.push(2);break;case TYPE_CODE.INT32:t=8,c.push(4)}return t})(),"0"),o=r+o.toBigEndian();break;case"float":c.push(4),o=TYPE_CODE.FLOAT32+Number(o).toHex();break;case"lvar":c.push(2),o=TYPE_CODE.LVAR+Number(o.r("@","")).toString(16).padStart(4,"0").toBigEndian();break;case"gvar":if(c.push(2),/\$/.test(o))if(o=o.r(/(i|f)?\$/,""),/\w/.test(o)){let e=!1;CUSTOM_VARIABLES.forEach(t=>{o==t[1]&&(e=t[0])}),o=0==e?(1e3<(o=parseInt(Number(String(parseInt(o,35)).substring(0,4)/2)))&&(o/=5),500<o&&(o/=2),parseInt(o)):e}else o*=4;else o=Number(o.r("&",""));o=TYPE_CODE.GVAR+o.toString(16).substring(0,4).padStart(4,"0").toBigEndian();break;case"label":c.push(4),o=TYPE_CODE.INT32+`<${o}>`;break;default:o=""}t.push(o)}}),p.push(t)}}),log(p);let t=p.toString().r(/,/g,"").toUpperCase();return t.r(/<@([^<>]+)>/g,t=>{let e=!1,a=0,r=t.substring(2,t.length-1);return c.forEach(t=>{if(0==e)switch(typeof t){case"number":a+=t;break;case"string":t==r&&(e=!0,a=(4294967295-a+1).toString(16).padStart(4,0).toUpperCase())}}),0==e?(alert("No se encontro la etiqueta de punto de salto: "+r+"\n- Revise si la escribio correctamente o si incluso la creeo."),"F3FFFFFF"):a.toBigEndian()})}log("NO ADD SPACES IN STRINGS")},String.prototype.toCompileSCM=function(r){if(0==r.length)alert("E-00: Añada un nombre al archivo.");else if(r.match(/\./))if(0==this.length)alert("E-02: Añada comandos al archivo.");else{let a=this.Translate();if(!(a.length%2)){let e=new Array;for(let t=0;t<a.length/2;t++){var o=a.substr(2*t,2);e[t]=parseInt(o,16)}var n=new Uint8Array(e);let t=window.document.createElement("a");return t.href=window.URL.createObjectURL(new Blob([n],{type:"application/octet-stream"})),t.download=r,document.body.appendChild(t),t.click(),document.body.removeChild(t),a}alert("E-03: la longitud de la cadena hexadecimal limpiada es impar.")}else alert("E-01: Añada una extencion al archivo.")};