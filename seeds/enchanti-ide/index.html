<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Enchanti IDE</title>
	<link rel="stylesheet" href="./../../css/main.css">
	<link rel="stylesheet" href="./styles.css">
	<link rel="manifest" href="./manifest.json">
  <meta name="description" content="Enchanti IDE es una potente herramienta para hacer CLEO Scripts multi-plataforma para GTA San Andreas, con una syntaxis basada en SB4 y JS">
</head>
<body style="display: block;">
<!--
<div id="autocomplete" style="
    background: #28313e;
    position: absolute;
    display: block;
    top: calc(168px - -1.5em);
    left: calc(179px - 0.5em);
    padding: 0.1em 0.4em;
    margin: 0;
    border: 0;
">#JESTES = 345</div>
-->
<script>

	// GLOBAL VARS
	const D = document

	const SP = String.prototype
	const EP = Element.prototype

	//const SP = String.prototype
	//const EP = Element.prototype

	NodeList.prototype.forEach = Array.prototype.forEach

/** Smart selector for elements of the DOM
 * @param {DOMString}
 * @param {Element|Function} optional
 * @return {Element}
*/
const $ = (element, _parent = D) => {
	const callback = _parent
	if (typeof _parent == 'function'){
		_parent = D
	}
	const xElements = _parent.querySelectorAll(element)
	const length = xElements.length

	element = element.charAt(0) === '#' && !/\s/.test(element) || length === 1
		? _parent.querySelector(element)
		: length === 0
			? undefined
			: xElements

	if (typeof callback == 'function'){
		if(element){
			if('' + element == '[object NodeList]'){ 
				element.forEach(function(e,i){
					callback(e,i)
				})
			}else{  
				callback(element)
			}
		}
	}else{
		return element
	}
}

/** Smart selector for elements of the DOM
 * @param {DOMString}
 * @return {Element}
*/
const new$ = (element, parent = 'body') => {
	let $temp = D.createElement(element)
	$(parent).appendChild($temp)
	return $temp
}
/** Shotcun of String.replace()
*/
String.prototype.r = function(text, _text='', _flags=''){
	return this.replace(text, _text, _flags)
}

/** Polifill and shotcun of String.replaceAll()
*/
String.prototype.rA = function(text, _text=''){
	var temp = this

	if(temp.indexOf(text, 0) !== -1){
		temp = temp
		.r(text, _text)
		.rA(text, _text)
	}
	
	return temp
}

/** Apply a function to all elements of the DOM
 * @param {NodeList} 
 * @param {function}
*/
function apply(element, callback){
	if(element){
		if('' + element == '[object NodeList]'){ 
			element.forEach(function(e){
				callback(e)
			})
		}else{  
			callback(element)
		}
	}
}
SP.dividirCadena = function() {
    const resultado = [];
    let dentroComillas = false;
    let subcadenaActual = '';
    let comilla = 0

    for (let i = 0; i < this.length; i++) {
        const caracter = this[i];
        const caracterAnterior = this[i-1];

        if (caracter === '"' || caracter === "'"){
          if (caracterAnterior != '\\') {
             dentroComillas = !dentroComillas;
          }
          
          subcadenaActual += caracter;
        } else if (caracter === ' ' && !dentroComillas) {
            // Si encontramos un espacio fuera de las comillas, guardamos la subcadena actual
            if (subcadenaActual.trim() !== '') {
                resultado.push(subcadenaActual);
            }
            subcadenaActual = '';
        } else {
            subcadenaActual += caracter;
        }
    }

    // Al final, si hay una subcadena no vacía, la agregamos al resultado
    if (subcadenaActual.trim() !== '') {
        resultado.push(subcadenaActual);
    }

    return resultado;
}


let shared_db = JSON.parse(localStorage.getItem("shared_db") || "")

SP.fixOpcodes = function(){
  let tm = this.split('\n').map(line => {
    let negado = false
    line = line.trim().dividirCadena()
    
    if (line.length >= 1){
      if (line[0].length < 5 && line[0].endsWith(':')){
        line[0] = line[0].r(/:$/m)
        if (line[0].startsWith('!')){
          line[0] = line[0].r(/^\!/m).hexToDec()
          line[0] += 0b1000000000000000
          line[0] = line[0].toString(16)
        }
        line[0] = (line[0]+'').padStart(4, '0') + ':'
      }
    }
    
    line = line.join(' ')
    return line
  }).join('\n')
  
  return tm
}


EP.class = function(str){
  if (!/^[\?\+\-\~\>]/m.test(str))
    return alert("add action");
  
  if (action == '+') this.classList.add(str);
  if (action == '-') this.classList.remove(str);
  if (action == '~') this.classList.toggle(str);
  if (action == '>') this.classList.replace(str);
  if (action == '?')
    return this.classList.contains(str)
}

	EP.next = function(){
		return this.nextElementSibling
	}

	EP.previous = function(){
		return this.previousElementSibling
	}
	
	EP.gAttr = function (attr){
	  return this.getAttribute(attr)
	}
	
  EP.sAttr = function(attr, val="") {
    this.setAttribute(attr, val)
  }

	EP.hidden = function(){
	    return this.style.display == "none"
	}

	EP.show = function(){
	    this.style.display = "block"
	}

	EP.hide = function(){
	    this.style.display = "none"
	}

	EP.toggle = function(c){
		if (c){
			setTimeout(function(){
				// Clear the hash
				history.pushState('', document.title, location.pathname)
			}, 12)	
		}

		if (this.classList.contains("d-block")){
			this.classList.remove('d-block')
			this.style = 'display:block'
		}
		if (this.classList.contains("d-none")){
			this.classList.remove('d-none')
			this.style = 'display:none'
		}

		getComputedStyle(this).display == "block"
			? this.hide()
			: this.show()
		;
	}

	EP.setCursor = function(atPosition){
	    this.setSelectionRange(atPosition, atPosition);
	    this.focus();
	}
	
	EP.setCursorFull = function (linea, columna) {
	  linea<1?linea=1:linea
    // Obtenemos el contenido del TextArea
    const contenido = this.value;

    // Calculamos la posición del cursor en función de la línea y columna
    let posicionCursor = 0;
    let lineas = contenido.split("\n");
    for (let i = 0; i < Math.min(linea - 1, lineas.length); i++) {
        posicionCursor += lineas[i].length + 1; // Sumamos 1 para el salto de línea
    }
    posicionCursor += Math.min(columna, lineas[linea - 1].length);

    // Establecemos la posición del cursor
    this.selectionStart = posicionCursor;
    this.selectionEnd = posicionCursor;
    
    updateDataLine()
}


	EP.getCursor = function(){
		return [this.selectionStart, this.selectionEnd]
	}

	EP.getLine = function(){
		let t = this.getCursor()
		let posicionCursor = t[0] != t[1] ? t[0] - t[1] : t[0];
		let stringRequerido = this.value.substr(0, posicionCursor)
		let lineaCursor = stringRequerido.split("\n").length;
		let posicionLinea = stringRequerido.lastIndexOf("\n") + 1;
		const textLine = this.value.split("\n")[lineaCursor-1].trim()
		let primerPalabra = textLine.split(' ')[0]
		
		const columnaCursor = posicionCursor-posicionLinea
		
		let tempA = (str) =>{
		  let palabra = ''
		  let corta = " ,<>{}()[]\t\n"
		  for (let i = columnaCursor; i < str.length; i++){
		    if (corta.includes(str[i])) break;
		    palabra += str[i]
		  }
		  for (let i = columnaCursor-1; i >= 0; i--){
		    if (corta.includes(str[i])) break;
		    palabra = str[i] + palabra
		  }
		  return palabra
		}
		const inSelection = posicionCursor < 0
		
		let mediaPalabra = ''
		if (!inSelection) {
		  mediaPalabra = tempA(this.value.split("\n")[lineaCursor - 1])
		}
		
		const charsSelected = inSelection ? posicionCursor*-1 : 0
		const textSelected = this.value.substr(
		  this.getCursor()[0],
		  this.getCursor()[1]
		)
		
		const output = {
			lineaCursor, columnaCursor,
			inSelection, charsSelected,
			textSelected, primerPalabra,
			mediaPalabra, textLine
		}
		return output
	}

	EP.AddAtSection = function(text){
	  var start = this.selectionStart;
	  var end = this.selectionEnd;
	  this.value = this.value.substring(0, start) + text + this.value.substring(end);
	  this.selectionStart = this.selectionEnd = start + 1; // Posiciona el cursor
	  this.focus()
	}

	EP.obtenerUltimaPalabra = function() {
    const contenido = this.value.trim();
    let cursorPosicion = this.selectionStart;

    // Buscamos la posición del espacio, tabulación, salto de línea o retorno de carro anterior al cursor
    const regex = /[\s\t\n\r]+/g;
    const palabras = contenido.split(regex);

    // Obtenemos la última palabra antes del cursor
    let ultimaPalabra = "";
    for (let i = 0; i < palabras.length; i++) {
        if (palabras[i].length + 1 <= cursorPosicion) {
            cursorPosicion -= palabras[i].length + 1;
        } else {
            if (cursorPosicion === 0) {
                // Si el cursor está justo después de un espacio, avanzamos al siguiente
                i++;
            }
            ultimaPalabra = palabras[i];
            break;
        }
    }

    // Verificamos si la última palabra es un espaciador de caracteres
    if (/\s/.test(ultimaPalabra)) {
        return ""; // No retornamos nada si es un espaciador
    }

    return ultimaPalabra;
}

EP.getTextSelected = function() {
    let start = this.selectionStart;
    let end = this.selectionEnd;
    return this.value.substring(start, end);
}

	EP.CopyTextContent = function() {
		let $temp = new$("textarea")
		$temp.value = (typeof this == 'object' ? this.textContent : this)
		$temp.select();
		D.execCommand("copy")
		$('body').removeChild($temp)
	}
</script>

<div id="navbar_pc"></div>

<style>
.f-2 {
	font-size: 1.2rem;
}
.bg-none {
	background: none!important;
}
button, label {
	border: none;
	font-size: .7rem;
	background: none;
	color: #fff;
}
input[type=text]{
  background: #200029;
  border-bottom: 1px solid #200029;
}

#editor-counterLine span {
  font-size: .7rem;
  color:white;
}

#OUTHEX {
  height: 30dvh!important;
  overflow: auto;
  display: block
}
</style>

<form id="FORMULARIO">


<div class="d-flex between subheader">
 <div>
  <input type="text" id="FILENAME" placeholder="File name" autocomplete="off" spellcheck="false" value="EnchantiScript.csi">
		<input id='file' type='file' accept='.txt,.ini' class="d-none">
		<a action onclick="saveSource()" tip=Download>⇊️</a> 
		<a action onclick="compilerSource()" tip=Compile>⇶️</a>
 </div>
 <div id="change-view" class="pr-2 size-4">
  <span onclick="localStorage.setItem('code-cached',$('#HEX').value)" tip='Save' id='state' class="loading yellow" action >ᛟ</span>
   <btn action tip='compiled preview' class="bg-none d-sm-none green d-none"  onclick="
   $('#HEX').toggle();
   $('#PREVIEW').toggle();
   $('#OUTHEX').toggle();
   $('#editor-counterLine').toggle();">ᛒ</btn>
 </div>
</div>

<div id="editor-body">
  <pre id="editor-counterLine" class="m-0 r-0"></pre>
  
	<textarea id="HEX" class="w-100 m-0 r-0 p-1 pl-5" placeholder="WIZARD, CAST THY SPELL!
	ᚹᛁᛉᚨᚱᛞ, ᚲᚨᛊᛏ ᚦᚤ ᛊᛈᛖᛚᛚ!" autocomplete="off" spellcheck="false">{ Syntax based on SB4 and JS }
0000: this_is_a_NOP
$misc != 0xff ? 7@ = !7@ : A = B || 0b1000
X = 3@+1 == 5_5 ? false : undefined
function(2@(3@++,123), "test\t#1 <=")
0@ = Char.Create(PedType.Gang1, #FAM1, .0, 0f, 0.0)
.SetHeading(0@ 1)
subrutine()
while !.DoesExist($Player_Actor--)
  wait .3s /* remember the last class */
  if IS_KEY_PRESSED KeyCode.A
  then break
  else continue
  end
end
terminate_this_script
// gosubs & funcs here ↓
:subrutine
return

:function
cleo_return 0 {}</textarea>
<pre id='PREVIEW' style="filter: blur(2px);" class="w-100 m-0 r-0 p-1"></pre>
</div>

	<pre type="text" id="OUTHEX" placeholder="hex's output" name="cleaned_hex" disabled class="w-100 m-0 r-0 pr-1 green"></pre>
<div style='background: #2c003e'>
<div id='assistance_android'></div>


	<!--<input type="checkbox" id="CHBSEPARATOR" checked="checked">Remover "0x" de los grupos de entrada<br><br>-->

</form>

<blockquote class="warning">
Bugs found:<br>
IDE does not load <a onclick="
  localStorage.clear()
   window.location.href = window.location.href
  ">clicking here</a>, wait 3s and <a href=index.html>refresh page</a>.<br>
Array support is limited to LVAR_LVAR @(@,n).<br>
</blockquote>
<div id='documentation'></div>

<footer class="center gray">
Author: MatiDragon ; Contributors: Seemann, OrionSR, Miran.
</footer>

<script src="js/utils/css.min.js"></script>

<script type="module" src="js/views.js"></script>
<script type="module" src="js/compiler.js"></script>
<script type="module" src="js/descompiler.js"></script>

<script>
let h = localStorage.getItem('code-cached')??''
$('#HEX').value=h
$('#HEX').focus()
$('#PREVIEW').innerHTML=h
h=void(0)

function saveSource(){
  let a = document.createElement('a');
  
  a.href = window.URL.createObjectURL(new Blob([$('#HEX').value], { type: 'text/plain' }));
  a.download = $('#FILENAME').value.r(/\.[^\.]+$/m, '.txt');
  
  // Append anchor to body.
  document.body.appendChild(a)
  a.click();
  
  // Remove anchor from body
  document.body.removeChild(a)
}
function compilerSource(){
  $('#FORMULARIO').cleaned_hex.value = $('#HEX').value.toCompileSCM($('#FILENAME').value)

	$('#HEX').click();
}


// Función para leer un archivo INI y obtener un valor específico
function IniFile_GET(iniContent, section, key) {
	// Supongamos que tienes el contenido del archivo INI en una cadena llamada 'iniContent'
	// Puedes cargar el contenido desde un archivo o proporcionarlo directamente

	// Parseamos el contenido del archivo INI
	function parseINIString(data) {
			const regex = {
					section: /^\s*\[\s*([^\]]*)\s*\]\s*$/,
					param: /^\s*([^=]+?)\s*=\s*(.*?)\s*$/,
					comment: /^\s*;.*$/
			};

			const value = {};
			let currentSection = null;
      
			data.split(/\r?\n/).forEach(line => {
					if (regex.comment.test(line)) {
							return;
					} else if (regex.param.test(line)) {
							const [, key, val] = line.match(regex.param);
							if (currentSection) {
									value[currentSection][key] = val;
							} else {
									value[key] = val;
							}
					} else if (regex.section.test(line)) {
							const [, section] = line.match(regex.section);
							value[section] = {};
							currentSection = section;
					}
			});
      
			return value;
	}

	// Aquí debes cargar el contenido del archivo INI o proporcionarlo directamente
	const parsedINI = parseINIString(iniContent);


	// Buscamos el valor en la sección y clave especificadas
	if (parsedINI[section] && parsedINI[section][key]) {
			return parsedINI[section][key];
	} else {
			return null; // Valor no encontrado
	}
}

function parseIniToCLEO (ini){
	let MODELS = localStorage.getItem('./data/models.ide').split('\n')
	MODELS.forEach((model, i) => MODELS[i] = model.split(' '))

	let code = 'nop\n'

  let
   interior=  IniFile_GET(ini,"game","set.interior")
   
   code += `Interior.SetVisible(${interior})\n`
   code += `Actor.SetLinkInInterior(_Player,${interior})\n`

  let model = IniFile_GET(ini,"player","model")
  if (model > 0 && model <= 288){
    code += `0@ = ${model}
        Model.Load(0@)
        repeat
          wait 0
        until Model.Available(0@)
        Player.SetModel(_Char,0@)
        Model.Release(0@)\n
    `
  }


  let
	  x   = IniFile_GET(ini, 'player', 'gcoord.x'),
	  y   = IniFile_GET(ini, 'player', 'gcoord.y'),
	  z   = IniFile_GET(ini, 'player', 'gcoord.z')
	
	code += `Actor.SetPosition(_Player,${x},${y},${z})\n`
	
	let
	  weather = IniFile_GET(ini, 'time', 'set.weather'),
	  hour = IniFile_GET(ini, 'time', 'set.hour'),
	  minute = IniFile_GET(ini, 'time', 'set.minute')
	  
	code += `Weather.SetForceNow(${weather})\n`
	code += `Game.SetTime(${hour},${minute})\n`
	
	
	
	let indActor = 0,
	  numActor = IniFile_GET(ini, 'numbers', 'actors'),
	  indAutos = 0,
	  numAutos = IniFile_GET(ini, 'numbers', 'actors'),
	  indObjetos = 0,
	  numObjetos = IniFile_GET(ini, 'numbers', 'actors')

  return code +'\nend_thread'
  // ===================

	const GENERATION = {
			NORMAL:0,
			SPECIAL:1,
			CUSTOM:2,
			RANDOM:3,
			ROPE_NORMAL:4,
			ROPE_SPECIAL:5,
			ROPE_CUSTOM:6,
			ROPE_RANDOM:7,
	}

	const LoadSpecialActor = {
		0 : 'ANDRE',
		1 : 'BBTHIN',
		2 : 'BB',
		3 : 'CAT',
		4 : 'CESAR',
		5 : 'COPGRL1',
		6 : 'COPGRL2',
		7 : 'CLAUDE',
		8 : 'CROGRL1',
		9 : 'CROGRL2',
		10 : 'DWAYNE',
		11 : 'EMMET',
		12 : 'FORELLI',
		13 : 'JANITOR',
		14 : 'JETHRO',
		15 : 'JIZZY',
		16 : 'HERN',
		17 : 'GANGRL1',
		18 : 'GANGRL2',
		19 : 'GUNGRL1',
		20 : 'GUNGRL2',
		21 : 'KENDL',
		22 : 'MACCER',
		23 : 'MADDOGG',
		24 : 'MECGRL1',
		25 : 'MECGRL2',
		26 : 'NURGRL1',
		27 : 'NURGRL2',
		28 : 'OGLOC',
		29 : 'PAUL',
		30 : 'PULASKI',
		31 : 'ROSE',
		32 : 'RYDER',
		33 : 'RYDER2',
		34 : 'RYDER3',
		35 : 'SINDACO',
		36 : 'SMOKE',
		37 : 'SMOKEV',
		38 : 'SUZIE',
		39 : 'SWEET',
		40 : 'TBONE',
		41 : 'TENPEN',
		42 : 'TORINO',
		43 : 'TRUTH',
		44 : 'WUZIMU',
		45 : 'ZERO',
		46 : 'PSYCHO',
		47 : 'MEDIATR',
		48 : 'LVPDM1',
		49 : 'SFPDM1',
		50 : 'WMYCD2',
		51 : 'VWMYAP',
		52 : 'CDEPUT',
		53 : 'CSBLUE3',
		54 : 'CSOMOST',
		55 : 'CSPRO1',
		56 : 'SBMYTR4',
		57 : 'CSMECH',
		58 : 'FAM4',
		59 : 'FAM5',

		60 : 'OGBURG',
		61 : 'MAFZI2',
		62 : 'MAFZI1',
		63 : 'SALVAR',
		64 : 'RALPH',
		65 : 'BOGM',
		66 : 'TRIDA',
		67 : 'TRIDB',
		68 : 'TBOSS',
		69 : 'SILVERM',
		70 : 'HELPER',
		71 : 'DANCA',
		72 : 'DANCB',
		73 : 'BETS',
		74 : 'SUTA',
		75 : 'CSSUZIE',
		76 : 'CSKENDL',
		77 : 'CSDRUG1',
		78 : 'CSTEXAN',
		79 : 'CSJOSE',
		80 : 'CSBDUP',
		81 : 'CSSLUT',
		82 : 'CSWMORI',
		83 : 'CSHO',
		84 : 'CSBLUE2',
		85 : 'SOMYAP',
		86 : 'VWFYPR1',
	}

	let jumpCode = 0
/*
createActor(modelType, ModelId, PedType, 0@)
*/
	while (numActor > indActor){
		indActor++
		let slot = 'ACTOR'+indActor
		let actor = {
			modelType : IniFile_GET(ini, slot, 'special'),
			modelId : IniFile_GET(ini, slot, 'model'),
			pedType : IniFile_GET(ini, slot, 'type'),
			generation : 0,
			globalCoordX : IniFile_GET(ini, slot, 'gcoord.x'),
			globalCoordY : IniFile_GET(ini, slot, 'gcoord.y'),
			globalCoordZ : IniFile_GET(ini, slot, 'gcoord.z'),
			globalCoordA : IniFile_GET(ini, slot, 'gcoord.a'),
			localCoordX : IniFile_GET(ini, slot, 'lcoord.x'),
			localCoordY : IniFile_GET(ini, slot, 'lcoord.y'),
			localCoordZ : IniFile_GET(ini, slot, 'lcoord.z'),
			localCoordA : IniFile_GET(ini, slot, 'lcoord.a'),
			flags : IniFile_GET(ini, slot, 'props'),
			health_armor : IniFile_GET(ini, slot, 'health_armor'),
			attached : IniFile_GET(ini, slot, 'attached'),
			weapon_ammon : IniFile_GET(ini, slot, 'weapon_ammon'),
			acuraci_mlle : IniFile_GET(ini, slot, 'acu.mlle'),
			acuraci_wpon : IniFile_GET(ini, slot, 'acu.wpon'),
			acuraci_dist : IniFile_GET(ini, slot, 'acu.dist'),
			rep_anim : IniFile_GET(ini, slot, 'rep.anim'),
			ifp_file : IniFile_GET(ini, slot, 'ifp.file'),
			ifp_anim : IniFile_GET(ini, slot, 'ifp.anim'),
			style_fght : IniFile_GET(ini, slot, 'sty.fght'),
			style_walk : IniFile_GET(ini, slot, 'sty.walk'),
		}

		if (actor.pedType == 23) {
			actor.modelId = ~~(actor.modelType / 10)
			actor.generation = actor.modelType

			while (actor.generation >= 10){
				actor.generation -= 10
			}

			if (actor.generation == (GENERATION.SPECIAL || GENERATION.ROPE_SPECIAL)){
				code += `23c: load_special_actor '${LoadSpecialActor[actor.modelId]}' as 1\n`
			}
			if (actor.generation == (GENERATION.CUSTOM || GENERATION.ROPE_CUSTOM)){
				code += `23c: load_special_actor '@${actor.modelId}' as 1\n`
			}
			jumpCode = code.length
			code += `:L${jumpCode}
wait 0
if 0x0
23D:  special_actor 1 loaded
4D: jump_if_false @L${jumpCode}
`
			if (actor.generation == GENERATION.SPECIAL
				||actor.generation == GENERATION.CUSTOM){
				code += `9A: create_actor_type 23 model #SPECIAL01 at ${actor.globalCoordX} ${actor.globalCoordY} ${actor.globalCoordZ} saving_at ${indActor}@\n`
			}
			if (actor.generation == GENERATION.ROPE_SPECIAL
				||actor.generation == GENERATION.ROPE_CUSTOM){
				code += `503: create_actor_onrope_type 23 model #SPECIAL01 at ${actor.globalCoordX} ${actor.globalCoordY} ${actor.globalCoordZ} saving_at ${indActor}@\n`
			}
			code += `173: actor ${indActor}@ set_angle ${actor.globalCoordA}
296: release_special_actor 1\n`

		}else{
			for (let search = 0; search < MODELS.length; search++) {
				if (MODELS[search][0] == actor.modelId){
					actor.modelId = '#'+ MODELS[search][1].r(/[\s\r]/, '')
					break
				}
			}


			jumpCode = code.length
			code += `247: load_model ${actor.modelId}
:L${jumpCode}
wait 0
if 0x0
247:  model ${actor.modelId} available
4D: jump_if_false @L${jumpCode}
9A: create_actor_type ${actor.pedType} model ${actor.modelId} at ${actor.globalCoordX} ${actor.globalCoordY} ${actor.globalCoordZ} saving_at ${indActor}@
173: actor ${indActor}@ set_angle ${actor.globalCoordA}
249: release_model ${actor.modelId}
\n`
		}
		code += '\n'
	}
	code = `nop
wait 0
${code}
terminate_this_script
`
	return code
}

const $node = $('#HEX')
const $file = $('#file')

const openFile = event => {
  const input = event.target
  if (!input) throw new Error('null input')
  const [first] = input.files

  const reader = new FileReader()
  reader.onload = () => {
    let text = reader.result


    if(first.name.toLowerCase().endsWith('.ini')){
		  text = parseIniToCLEO(text)
    }

    $node.value = text
    hl()
    
    $('#OUTHEX').innerText = $node.value.Translate(true, true)
  }
  
  reader.readAsText(first)
   $('#FILENAME').value = first.name.r(/\.([^.]+)$/m, '.csi')
}

$file.onchange = openFile
</script>
<script>
hl()

$node.onclick = () => {
	hl()
    $('#OUTHEX').innerText = $node.value.Translate(true,true)
    
}

let codigoOriginal = $node.value
let codigoModificado = codigoOriginal
$node.oninput = (e)=>{
  codigoOriginal = $node.value
  hl()
  const ele = e.target
  
  let keyDown = ele.value.substr(ele.selectionStart-1, 1).toLowerCase()
  
  if (codigoOriginal.length < codigoModificado.length)
    keyDown = 'backspace';
  
  if (keyDown === '') keyDown = 'backspace'
  if (keyDown === ' ') keyDown = 'space'
  if (keyDown === '\t') keyDown = 'tab'
  if (keyDown === '\n') keyDown = 'enter'
  
  const pares = {
    '(':')',
    '{':'}',
    '[':']',
    '"':'"',
    '`':'`',
    "'":"'"
  }
  //textLength
  if (keyDown in pares){
    document.execCommand("insertText",false,pares[keyDown])
    
    ele.focus();
    if (/['"`]/.test(keyDown)){
      ele.selectionStart++
      ele.selectionEnd--
    }else {
      ele.selectionStart--
      ele.selectionEnd--
    }
    
  }
  codigoModificado = codigoOriginal
}

$node.onmousemove = getLine
$node.onkeyup = (event) =>{
	try {
        $('#OUTHEX').innerText = $node.value.Translate(true,true)
        
        $('#error').style.display = 'none'
    //}
    } catch(error) {
      $('#error').style.display = 'flex'
		  $('#error').innerText = error
	}
}

function hasScrollBar(e) {
    return {
        vertical: e.scrollHeight > e.clientHeight,
        horizontal: e.scrollWidth > e.clientWidth
    };
}


function resaltadorV2(){
  let code = $('#HEX').value
  let text = ''
  
  $('#PREVIEW').innerHTML = text
}
function getLine() {
  textData = $node.getLine()
  /* lineaCursor, columnaCursor,
			inSelection, charsSelected,
			textSelected, primerPalabra, mediaPalabra */

  if (textData.inSelection) {
    $('#line').innerText = '[' + textData.charsSelected + ']'
    $('#opcode').innerText = ''
  } else {
    $('#line').innerText = textData.lineaCursor + ':' + textData.columnaCursor

    let $o = x => $('#opcode').innerText = x
    let $d = x => $("#short_desc").innerHTML = x

    let p = textData.primerPalabra.toLowerCase()
    let m = textData.mediaPalabra
    let o = shared_db[shared_db[p]] ?? shared_db[p]

    $d('')
    $o('')

    p = p.r(/^\w+\(\)$/, '0050:')

    if (/[^@$&]/.test(p))
      p = p.r('!');

    if (/^\w{1,4}:$/m.test(p))
      p = p.padStart(5, '0');

    let opcode = shared_db[p.r(':').toLowerCase()]

    if (/([a-z]\w+)?\.[a-z]\w+\(.+\)/i.test(textData.textLine)) {
      $o('class detected')

      //$d(shared_db[p.r(':')].short_desc)
    }
    else if (/^\!?[a-f\d]{1,4}:$/mi.test(p)) {
      if (opcode) {
        $o(
          '▼ ' + p.toUpperCase() + ':' +
          opcode.num_params +
          ' (' + (m != p ? m : '') + ')'
        )

        $d(opcode.short_desc + '<br><a href="https://library.sannybuilder.com/#/sa/default/' + p.replace(':', '') + '">read more</a>')
      }
      else {
        $o(
          '▼ ' + p.toUpperCase() + ':' +
          '?' +
          ' (' + (m != p ? m : '') + ')'
        )

        $d("opcode not found at the data_base")
      }
    }
    else if (opcode) {
      if (typeof o != 'object') {
        o = shared_db[o.toLowerCase()]
      }

      $o(
        '▼ ' + opcode.id + '::' +
        +(o.num_params) +
        ' (' + m + ')'
      )

      $d(o.short_desc + '<br><a href="https://library.sannybuilder.com/#/sa?q=' + opcode.id.toUpperCase() + '">read more</a>')

    }
    else if (/[\+\-\*\/=%<>!]?[=\-+][@#]?/.test(textData.textLine)) {
      $o('operation detected')
    }

  }
}
function hl(){
	
	
	
	$("#editor-counterLine").innerHTML = ''
  $('#HEX').value.split('\n').forEach((a,b)=>{
    $("#editor-counterLine").innerHTML += 
    ($('#HEX').getLine().lineaCursor == b+1 ? '<span>' : '')
    
    + (b+1) +
    ($('#HEX').getLine().lineaCursor == b+1 ? '</span>' : '')
    + '\n'
  })

  //resaltadorV2()
  
	const span = {
		start : "<span class=",
		end : ">$1<\/span>"
	}

	const enter = {
		comments  : span.start + "comments"   + span.end,
		numbers   : span.start + "numbers"    + span.end,
		variables : span.start + "variables"  + span.end,
		opcodes   : span.start + "opcodes"    + span.end,
		directives: span.start + "directives" + span.end,
		commands  : span.start + "commands"   + span.end,
		classes   : span.start + "classes"    + span.end
	}

	$('#PREVIEW').innerHTML = $('#HEX').value
	//Palabras Reservadas
	.r(/(^((\x20|\t|!)+)?[a-z_]+)(\s|$)/gmi, "<span class=keywords>$1<\/span>$4")
	.r(/(^$)/gm, '$1 ')
	//.rA('\t', '    ')
	.rA('&lt;br/&gt;', "\\n")
	//.r(/(^.)/gm, '<span class=contador><\/span>$1')
	//Comentarios 
	.r(/(\/\/([^\n]+)?)/gm, enter.comments)
	.r(/(\/\*[^\/]*(\*\/)?)/gm, enter.comments)
	.r(/(\{([^\$][^\{\}]*(\})?)?)/gm, enter.comments)
	//Directivas
	.r(/(\{\$[^{}\n]+\})/gm, enter.directives)
	//Cadenas de texto
	.r(/"((?:\\|[^"\\\n])+)(")?/gmi, match => {
	  match = match.rA("'", "’")
	  .r(/\\(x[a-f\d]{1,2}|t|n|'|"|`)/gi, "<span class=charScape>\\$1</span>")
	  return '<span class=strings>'+match+'</span>'
  })
	.rA('\\"</span>', '\\"')
	.rA('\\"<span>', '\\"')
	.r(/'((?:\\|[^'\\\n])+)(')?/gmi, match => {
	  match = match.rA('"', '”')
	  .r(/\\(x[\da-f]{1,2}|t|n|'|"|`)/gi, "<span class=charScape>\\$1</span>")
	  return "<span class=strings>"+match+"</span>"
  })
	.rA("\\'</span>", "\\'")
	.rA("\\'<span>", "\\'")
	.r(/`((?:\\|[^`\\])*)(`)?/gmi, match => {
	  match = match.r(/\\(x[\da-f]{1,2}|t|n|'|"|`)/g, "<span class=charScape>\\$1</span>")
	  return "<span class=strings>"+match+"</span>"
  })
	.rA("\\`</span>", "\\`")
	.rA("\\`<span>", "\\`")
	//Etiquetas
	.r(/([^\w\d_])([@:])([\w\d_]+)?/gim, "$1<span class=labels>$2$3<\/span>")
	.r(/([^\w\.])(\w+)(\([^\n]*\))/gmi, "$1<span class=commands>$2<\/span>$3")
	//Arreglos
	.r(/(\[)([\d+]*)(\])/gmi, "$1<span class=numbers>$2<\/span>$3")
	//Opcodes
	.r(/([a-f0-9]+\:)/gmi, enter.opcodes)
	//Variables ADMA
	.r(/((\&)([\d\-a-fx]+)?)/gim, enter.variables)
	//Variables globales
	.r(/((\x{00}|[ifsv])\$([\d\w]+)?)/gm, enter.variables)
	//Numeros
	.r(/\b(\d+([box.])\w+)\b/gmi, enter.numbers)
	.r(/\b(\-?\.?\d[e\+\-_\d\.]+(fps|[smh])?)\b/gmi, enter.numbers)
	.r(/\b(true|false|undefined|null|break|continue)\b/gmi, enter.numbers)
	.r(/(?!\#)(\W)(?!\$)([\d_]+)(?!\:|\@)([ifsv]?)\b/gmi, '$1<span class=numbers>$2$3<\/span>')
	//Modelos
	.r(/(c?\#(?![^\"\'\#\s])\w+)\b/gm, "<span class='models'>$1<\/span>")
	//Clases
	.r(/\b([a-z0-9]+)\.([a-z0-9]+)/gmi, "<span class=classes>$1</span>.<span class=commands>$2</span>")
	.r(/(\!?)\.([\w]+)/gmi, "$1.<span class=commands>$2</span>")
	.r(/(\w+)(\(.+\)\.)(\w+)/gmi, "<span class=classes>$1</span>$2<span class=commands>$3</span>")
	.r(/(\$\w+|\d+\@)\.([0-9A-Z_a-z]+)/gm, "$1.<span class=commands>$2</span>")
	.r(/(:|of) (\w+)\n/gm, "$1 <span class=classes>$2</span>\n")
	.r(/\.([0-9A-Z_a-z]+)\n/gm,"." + enter.commands +"\n")
	//Variables  
	.r(/\b(timer(a|b|x|z))\b/gmi, enter.variables)
	.r(/(\d+\@([ifsv])?)/gmi, enter.variables)
	// Operadores
	.r(/(^|\s)(\.|\=|\+|\-|\*|\/|\%|\=\=|\+\=|\-\=|\*\=|\/\=|\%\=|\!=|\+\+|\-\-|\<|\>|\<\=|\>\=|\?\?|\|\||\!)(\s|$)/gmi,"$1<span class=labels>$2<\/span>$3")
	.r(/(\!|\+\+|\-\-)/gmi,"<span class=labels>$1<\/span>")

	if (hasScrollBar($('#PREVIEW')).vertical){
	  $('#PREVIEW').scrollTop = $('#HEX').scrollTop
	  $("#editor-counterLine").scrollTop = $('#HEX').scrollTop
	}
	if (hasScrollBar($('#PREVIEW')).horizontal) $('#PREVIEW').scrollLeft = $('#HEX').scrollLeft;
}

$('#HEX').onscroll = () =>{
    
	if (hasScrollBar($('#PREVIEW')).vertical){
	  $('#PREVIEW').scrollTop = $('#HEX').scrollTop
	  $("#editor-counterLine").scrollTop = $('#HEX').scrollTop
	}
	if (hasScrollBar($('#PREVIEW')).horizontal) $('#PREVIEW').scrollLeft = $('#HEX').scrollLeft;
}




</script>



<script>
  if (typeof navigator.serviceWorker !== 'undefined') {
    navigator.serviceWorker.register('sw.js')
    .then(() => { console.log('Service Worker Registered'); });
  }
  
  const CACHE_NAME = "v1";
const OFFLINE_URL = "index.html";
const ASSETS = [
  OFFLINE_URL,
  "/../../css/main.css",
  "/../../js/css.js",
  '/js/compiler.js',
  '/js/utils/css.min.js',
  '/js/utils/*',
  "/data/*",
  "/"
  // Agrega aquí otros recursos que quieras precachear
];

self.addEventListener("message", (event) => {
  if (event.data && event.data.type === "SKIP_WAITING") {
    self.skipWaiting();
  }
});

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        cache.addAll(ASSETS)
        console.log(ASSETS)
      })
      .catch((error) => {
        console.error(`onRejected function called: ${error.message}`);
      })
      .then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheName !== CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    }).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', (event) => {
  if (event.request.mode === 'navigate' || (event.request.method === 'GET' && event.request.headers.get('accept').includes('text/html'))) {
    event.respondWith(
      fetch(event.request).catch(() => {
        return caches.open(CACHE_NAME).then((cache) => {
          return cache.match(OFFLINE_URL);
        });
      })
    );
  }
});





let deferredPrompt;
const addBtn = document.querySelector('#name-app');

window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent Chrome 67 and earlier from automatically showing the prompt
  e.preventDefault();
  // Stash the event so it can be triggered later.
  deferredPrompt = e;
  // Update UI to notify the user they can add to home screen
  addBtn.style.display = 'block';

  addBtn.addEventListener('click', () => {
    // hide our user interface that shows our A2HS button
    addBtn.style.display = 'none';
    // Show the prompt
    deferredPrompt.prompt();
    // Wait for the user to respond to the prompt
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log('User accepted the A2HS prompt');
      } else {
        console.log('User dismissed the A2HS prompt');
      }
      deferredPrompt = null;
    });
  });
});

</script>
</body>
</html>