<!DOCTYPE html>
<html lang="en" commit="45">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MattyBuilder</title>
	<link rel="stylesheet" href="./../../css/main.css">
</head>
<body style="display: block;">
<!--
<div id="autocomplete" style="
    background: #28313e;
    position: absolute;
    display: block;
    top: calc(168px - -1.5em);
    left: calc(179px - 0.5em);
    padding: 0.1em 0.4em;
    margin: 0;
    border: 0;
">#JESTES = 345</div>
-->
<div style="margin: 1em;">
<style>
* {
	font-size: 1rem;
}
.contador {
    counter-increment: listing;
    color: grey;
    width: 3.5em;
    position: relative;
    display: inline-block;
}
.contador::before {
    content: counter(listing, decimal-leading-zero);
}
#state {
    border: #00c853 solid 1px;
}
#state.loading {
    border: #ff5252 solid 1px !important;
}
#version_sbl, #state{
    width: 5rem;
    text-align: center;
}
</style>
<script>

const D = document

//const SP = String.prototype
//const EP = Element.prototype

NodeList.prototype.forEach = Array.prototype.forEach

/** Smart selector for elements of the DOM
 * @param {DOMString}
 * @param {Element} optional
 * @return {Element}
*/
function $(element, _parent) {
	_parent = _parent || D
	const xElements = _parent.querySelectorAll(element)
	const length = xElements.length

	if (element.charAt(0) === '#' && !/\s/.test(element) || length === 1) { 
		return _parent.querySelector(element);
	}
	else {
		if(length === 0){return undefined}
		return xElements;
	}
}

/** Shotcun of String.replace()
*/
String.prototype.r = function(text, _text, _flags){
	_text = _text || ''
	_flags = _flags || ''
	return this.replace(text, _text, _flags)
}

/** Polifill and shotcun of String.replaceAll()
*/
String.prototype.rA = function(text, _text){
	var temp = this
	_text = _text || ''

	if(temp.indexOf(text, 0) !== -1){
		temp = temp
		.r(text, _text)
		.rA(text, _text)
	}
	
	return temp
}

/** Apply a function to all elements of the DOM
 * @param {NodeList} 
 * @param {function}
*/
function apply(element, callback){
	if(element){
		if('' + element == '[object NodeList]'){ 
			element.forEach(function(e){
				callback(e)
			})
		}else{  
			callback(element)
		}
	}
}

function getLine(){
	let t = [$node.selectionStart, $node.selectionEnd]
	let posicionCursor = t[0] != t[1] ? t[0] - t[1] : t[0];
	let lineaCursor = $node.value.substr(0, posicionCursor).split("\n").length;
	let posicionLinea = $node.value.substr(0, posicionCursor).lastIndexOf("\n") + 1;

	if (posicionCursor < 0)
		$('#line').innerText = `${posicionCursor*-1} characters selected`
	else
		$('#line').innerText = `Line ${lineaCursor}, Column ${posicionCursor-posicionLinea}`
}
</script>

<form id="FORMULARIO">

<input id='file' type='file' accept='.txt,.ini' class="d-none">
<label class="button" for="file">load</label>

<a id="" class="button" onclick="
	let a = window.document.createElement('a');

	a.href = window.URL.createObjectURL(new Blob([$('#HEX').value], { type: 'text/plain' }));
	a.download = $('#FILENAME').value.r(/\.[^\.]+$/m, '.txt');

	// Append anchor to body.
	document.body.appendChild(a)
	a.click();

	// Remove anchor from body
	document.body.removeChild(a)
	" style="
    cursor: pointer;">save</a> <a id="" class="button" onclick="

$('#FORMULARIO').cleaned_hex.value = $('#HEX').value.toCompileSCM($('#FILENAME').value)

	$('#HEX').click();

	" style="
    cursor: pointer;">compiler</a><br><br>
	<input type="text" id="FILENAME" placeholder="File name" autocomplete="off" spellcheck="false" value="newScript.csi">
	<textarea id="HEX" class="w-100 m-0" placeholder="write your hex" autocomplete="off" spellcheck="false" style="
    position: absolute;
    display: block;
    white-space: pre;
    width: calc(100% - 2em);
    color: transparent;
    background: transparent;
    caret-color: white;
    resize: none;
    padding: 4px 4px 4px 4.2em !important;
    margin: 0.6rem 0px;
    overflow: auto;
    max-height: 50vh;
    font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    line-height: 1.5em;
    font-size: 1rem!important;
    height: 50vh;
    ">nop // operations aritmetics suports: =, +=, -=, *=, /=, >, <, >=, <=
0@ += 0      // int
1@ -= 0x1C   // int
2@ -= 0b1111 // int
3@ = #jester // int
4@ *= 2f     // float
5@ /= 5.0    // float
6@ > .75     // float
7@ = 'string'     // string
8@ = "longstring" // string
:main
    wait 0@
goto @main

</textarea>
	<pre id='PREVIEW' style="
	height: 50vh;
	font-size: 1rem!important;
	filter: blur(2px);
	transition: all 0.2s ease 0s;
	" class="m-0"></pre>

	<div id="error" placeholder="hex's output" name="cleaned_hex" class="w-100 p-1" style="
    background: #290000;
    color: #ff8080;
    white-space: pre-wrap;
    display: none;"></div>
	<input type="text" id="OUTHEX" placeholder="hex's output" name="cleaned_hex" disabled class="w-100">

<div class="d-flex between">
<div class="d-flex">
<span id='line'>Line 1, Column 0</span>
</div>
<div class="d-flex">
<span id='state' class="loading">Loading...</span>
<span id='version_sbl' class="">SBL</span>
<select id='mode' class="ml-1">
  <option value="gta3">GTA III</option>
  <option value="lcs">GTA LCS</option>
  <option value="sa" selected>GTA SA</option>
  <option value="vc">GTA VC</option>
  <option value="vcs">GTA VCS</option>
  <option value="gta3_mobile">III Mobile</option>
  <option value="sa_mobile">SA Mobile</option>
  <option value="vc_mobile">VC Mobile</option>
</select>
</div>
</div>

	<!--<input type="checkbox" id="CHBSEPARATOR" checked="checked">Remover "0x" de los grupos de entrada<br><br>-->

</form>

<blockquote class="warning">
ARRAY not have support.<br>
Syntax High-Level not implemented.<br>
The opcodes & keywords indefined, is remplace for the OP:0000.<br>
</blockquote>
<blockquote>
This editor use the data base of Library.SannyBuilder.com and files of edition MatiDragon.<br>
You can use the name of a command how Keywords or Opcodes for create scripts.<br>
The editor can invert Keywords with the prefix ! and NOT.<br>
</blockquote>
<br>
<script type="module" src="compiler.js"></script>
<script>

// Función para leer un archivo INI y obtener un valor específico
function IniFile_GET(iniContent, section, key) {
	// Supongamos que tienes el contenido del archivo INI en una cadena llamada 'iniContent'
	// Puedes cargar el contenido desde un archivo o proporcionarlo directamente

	// Parseamos el contenido del archivo INI
	function parseINIString(data) {
			const regex = {
					section: /^\s*\[\s*([^\]]*)\s*\]\s*$/,
					param: /^\s*([^=]+?)\s*=\s*(.*?)\s*$/,
					comment: /^\s*;.*$/
			};

			const value = {};
			let currentSection = null;

			data.split(/\r?\n/).forEach(line => {
					if (regex.comment.test(line)) {
							return;
					} else if (regex.param.test(line)) {
							const [, key, val] = line.match(regex.param);
							if (currentSection) {
									value[currentSection][key] = val;
							} else {
									value[key] = val;
							}
					} else if (regex.section.test(line)) {
							const [, section] = line.match(regex.section);
							value[section] = {};
							currentSection = section;
					}
			});

			return value;
	}

	// Aquí debes cargar el contenido del archivo INI o proporcionarlo directamente

	const parsedINI = parseINIString(iniContent);

	// Buscamos el valor en la sección y clave especificadas
	if (parsedINI[section] && parsedINI[section][key]) {
			return parsedINI[section][key];
	} else {
			return null; // Valor no encontrado
	}
}

function parseIniToCLEO (ini){
	let code = ''

	let indActor   = 0, numActor   = IniFile_GET(ini, 'numbers', 'actors'),
			indAutos   = 0, numAutos   = IniFile_GET(ini, 'numbers', 'actors'),
			indObjetos = 0, numObjetos = IniFile_GET(ini, 'numbers', 'actors')

	const GENERATION = {
			NORMAL:0,
			SPECIAL:1,
			CUSTOM:2,
			RANDOM:3,
			ROPE_NORMAL:4,
			ROPE_SPECIAL:5,
			ROPE_CUSTOM:6,
			ROPE_RANDOM:7,
	}

	const LoadSpecialActor = {
		0 : 'ANDRE',
		1 : 'BBTHIN',
		2 : 'BB',
		3 : 'CAT',
		4 : 'CESAR',
		5 : 'COPGRL1',
		6 : 'COPGRL2',
		7 : 'CLAUDE',
		8 : 'CROGRL1',
		9 : 'CROGRL2',
		10 : 'DWAYNE',
		11 : 'EMMET',
		12 : 'FORELLI',
		13 : 'JANITOR',
		14 : 'JETHRO',
		15 : 'JIZZY',
		16 : 'HERN',
		17 : 'GANGRL1',
		18 : 'GANGRL2',
		19 : 'GUNGRL1',
		20 : 'GUNGRL2',
		21 : 'KENDL',
		22 : 'MACCER',
		23 : 'MADDOGG',
		24 : 'MECGRL1',
		25 : 'MECGRL2',
		26 : 'NURGRL1',
		27 : 'NURGRL2',
		28 : 'OGLOC',
		29 : 'PAUL',
		30 : 'PULASKI',
		31 : 'ROSE',
		32 : 'RYDER',
		33 : 'RYDER2',
		34 : 'RYDER3',
		35 : 'SINDACO',
		36 : 'SMOKE',
		37 : 'SMOKEV',
		38 : 'SUZIE',
		39 : 'SWEET',
		40 : 'TBONE',
		41 : 'TENPEN',
		42 : 'TORINO',
		43 : 'TRUTH',
		44 : 'WUZIMU',
		45 : 'ZERO',
		46 : 'PSYCHO',
		47 : 'MEDIATR',
		48 : 'LVPDM1',
		49 : 'SFPDM1',
		50 : 'WMYCD2',
		51 : 'VWMYAP',
		52 : 'CDEPUT',
		53 : 'CSBLUE3',
		54 : 'CSOMOST',
		55 : 'CSPRO1',
		56 : 'SBMYTR4',
		57 : 'CSMECH',
		58 : 'FAM4',
		59 : 'FAM5',

		60 : 'OGBURG',
		61 : 'MAFZI2',
		62 : 'MAFZI1',
		63 : 'SALVAR',
		64 : 'RALPH',
		65 : 'BOGM',
		66 : 'TRIDA',
		67 : 'TRIDB',
		68 : 'TBOSS',
		69 : 'SILVERM',
		70 : 'HELPER',
		71 : 'DANCA',
		72 : 'DANCB',
		73 : 'BETS',
		74 : 'SUTA',
		75 : 'CSSUZIE',
		76 : 'CSKENDL',
		77 : 'CSDRUG1',
		78 : 'CSTEXAN',
		79 : 'CSJOSE',
		80 : 'CSBDUP',
		81 : 'CSSLUT',
		82 : 'CSWMORI',
		83 : 'CSHO',
		84 : 'CSBLUE2',
		85 : 'SOMYAP',
		86 : 'VWFYPR1',
	}

	let jumpCode = 0

	while (numActor > indActor){
		indActor++
		let slot = 'ACTOR'+indActor
		let actor = {
			modelType : IniFile_GET(ini, slot, 'special'),
			modelId : IniFile_GET(ini, slot, 'model'),
			pedType : IniFile_GET(ini, slot, 'type'),
			generation : 0,
			globalCoordX : IniFile_GET(ini, slot, 'gcoord.x'),
			globalCoordY : IniFile_GET(ini, slot, 'gcoord.y'),
			globalCoordZ : IniFile_GET(ini, slot, 'gcoord.z'),
			globalCoordA : IniFile_GET(ini, slot, 'gcoord.a'),
			localCoordX : IniFile_GET(ini, slot, 'lcoord.x'),
			localCoordY : IniFile_GET(ini, slot, 'lcoord.y'),
			localCoordZ : IniFile_GET(ini, slot, 'lcoord.z'),
			localCoordA : IniFile_GET(ini, slot, 'lcoord.a'),
		}

		if (actor.pedType == 23) {
			actor.modelId = ~~(actor.modelType / 10)
			actor.generation = actor.modelType

			while (actor.generation >= 10){
				actor.generation -= 10
			}

			if (actor.generation == (GENERATION.SPECIAL || GENERATION.ROPE_SPECIAL)){
				code += `023c: load_special_actor '${LoadSpecialActor[actor.modelId]}' as 1\n`
			}
			if (actor.generation == (GENERATION.CUSTOM || GENERATION.ROPE_CUSTOM)){
				code += `023c: load_special_actor '@${actor.modelId}' as 1\n`
			}
			jumpCode = code.length
			code += `:L${jumpCode}
	wait 0
	if 0x0
	023D:  special_actor 1 loaded
	004D: jump_if_false @L${jumpCode}
	`
			if (actor.generation == GENERATION.SPECIAL
				||actor.generation == GENERATION.CUSTOM){
				code += `009A: create_actor_type ${actor.pedType} model ${actor.modelId} at ${actor.globalCoordX} ${actor.globalCoordY} ${actor.globalCoordZ} saving_at ${indActor}@\n`
			}
			if (actor.generation == GENERATION.ROPE_SPECIAL
				||actor.generation == GENERATION.ROPE_CUSTOM){
				code += `create_actorRope_type ${actor.pedType} model ${actor.modelId} at ${actor.globalCoordX} ${actor.globalCoordY} ${actor.globalCoordZ} saving_at ${indActor}@\n`
			}
			code += '0296: release_special_actor 1\n'

		}else{
			code += `009A: create_actor_type ${actor.pedType} model ${actor.modelId} at ${actor.globalCoordX} ${actor.globalCoordY} ${actor.globalCoordZ} saving_at ${indActor}@\n`
		}
		code += '\n'
	}
	code = 'nop\n' + code + ':L${jumpCode}\nwait 5000\ngoto @L${jumpCode}'
	return code
}

const $node = $('#HEX')
const $file = $('#file')

const processTextByLine = text => {
    const arr = text.split(/\r?\n/gm)
    arr.map(line => console.log(line))
}

const openFile = event => {
  const input = event.target
  if (!input) throw new Error('null input')
  const [first] = input.files

  const reader = new FileReader()
  reader.onload = () => {
    let text = reader.result


    if(first.name.toLowerCase().endsWith('.ini')){
		text = parseIniToCLEO(text)
    }

    $node.value = text
    hl()
    
    processTextByLine(text)
  }
  
  reader.readAsText(first)
   $('#FILENAME').value = first.name.r(/\.([^.]+)$/m, '.csi')
}

$file.onchange = openFile
</script>
<script>
hl()
getLine()
$node.onclick = () => {
	hl()
    $('#OUTHEX').value = $node.value.Translate(true)
    getLine()
}
$node.oninput = hl
$node.onmousemove = getLine
$node.onkeyup = (event) =>{
	try {
	//console.log(event)
    //if (event.code == 'Enter' 
    //	|| event.code == 'Backspace'
    //	|| event.code == 'Space'){
        //let tempC = $node.value.Translate(true)
        $('#OUTHEX').value = $node.value.Translate(true)
        getLine()
        $('#error').style.display = 'none'
    //}
    } catch(error) {
        $('#error').style.display = 'flex'
		$('#error').innerText = error
	}
}

function hasScrollBar(e) {
    return {
        vertical: e.scrollHeight > e.clientHeight,
        horizontal: e.scrollWidth > e.clientWidth
    };
}


function hl(){
	getLine()

	const span = {
		start : "<span class=",
		end : ">$1<\/span>"
	}

	const enter = {
		comments  : span.start + "comments"   + span.end,
		numbers   : span.start + "numbers"    + span.end,
		variables : span.start + "variables"  + span.end,
		opcodes   : span.start + "opcodes"    + span.end,
		directives: span.start + "directives" + span.end,
		commands  : span.start + "commands"   + span.end,
		classes   : span.start + "classes"    + span.end
	}

	$('#PREVIEW').innerHTML = $('#HEX').value
	//Palabras Reservadas
	.r(/(^((\x20|\t|!)+)?[a-z_]+)(\s|$)/gmi, "<span class=keywords>$1<\/span>$4")
	.r(/(^$)/gm, '$1 ')
	//.rA('\t', '    ')
	.rA('&lt;br/&gt;', "\\n")
	.r(/(^.)/gm, '<span class=contador><\/span>$1')
	//Comentarios 
	.r(/(\/\/([^\n]+)?)/gm, enter.comments)
	.r(/(\/\*[^\/]*\*\/)/gm, enter.comments)
	.r(/(\{([^\$][^\{\}]*)?\})/gm, enter.comments)
	//Directivas
	.r(/(\{\$[^{}\n]+\})/gm, enter.directives)
	//Cadenas de texto
	.r(/\"([^\n"]+)\"/gmi, '<span class=strings>"$1"<\/span>')
	.rA('\\"</span>', '\\"')
	.rA('\\"<span>', '\\"')
	.r(/\'([^\n']+)\'/gmi, "<span class=strings>'$1'<\/span>")
	.rA("\\'</span>", "\\'")
	.rA("\\'<span>", "\\'")
	.r(/\`([^\n`]+)\`/gmi, "<span class=strings>`$1`<\/span>")
	.rA("\\`</span>", "\\`")
	.rA("\\`<span>", "\\`")
	//Etiquetas
	.r(/([^\w\d])([@:])([\w\d]+)?/gm, "$1<span class=labels>$2$3<\/span>")
	.r(/([^\w\d])([A-Za-z0-9_]+\(\))/gm, "$1<span class=commands>$2<\/span>")
	//Arreglos
	.r(/(\[)([\d+]*)(\])/gmi, "$1<span class=numbers>$2<\/span>$3")
	//Opcodes
	.r(/([a-fA-F0-9]{4}\:)/gmi, enter.opcodes)
	//Variables ADMA
	.r(/((\&)([\d\-a-fx]+)?)/gim, enter.variables)
	//Variables globales
	.r(/((\x{00}|[ifsv])(\$[\d\w]+))/gm, enter.variables)
	//Numeros
	.r(/\b(\d+(b|x|\.)\w+)\b/gmi, enter.numbers)
	.r(/\b(true|false)\b/gmi, enter.numbers)
	.r(/(?!\#)(\W)(?!\$)(\d+)(?!\:|\@)([ifsv]?)\b/gmi, '$1<span class=numbers>$2$3<\/span>')
	//Modelos
	.r(/(\#[^\"\'\#\s]+)\b/gm, "<span class='models'>$1<\/span>")
	//Clases
	.r(/\b([a-z0-9]+)\.([a-z0-9]+)/gmi, "<span class=classes>$1</span>.<span class=commands>$2</span>")
	.r(/(\w+)(\(.+\)\.)(\w+)/gmi, "<span class=classes>$1</span>$2<span class=commands>$3</span>")
	.r(/(\$\w+|\d+\@)\.([0-9A-Z_a-z]+)/gm, "$1.<span class=commands>$2</span>")
	.r(/(:|of) (\w+)\n/gm, "$1 <span class=classes>$2</span>\n")
	.r(/\.([0-9A-Z_a-z]+)\n/gm,"." + enter.commands +"\n")
	//Variables  
	.r(/\b(timer(a|b))\b/gmi, enter.variables)
	.r(/(\d+\@([ifsv]|\B)([^\w\d]|$))/gmi, enter.variables)
	// Operadores
	.r(/(^|\s)(\.|\=|\+|\-|\*|\/|\%|\=\=|\+\=|\-\=|\*\=|\/\=|\%\=|\+\+|\-\-|\<|\>|\<\=|\>\=)(\s|$)/gmi,"$1<span class=labels>$2<\/span>$3")

	if (hasScrollBar($('#PREVIEW')).vertical) $('#PREVIEW').scrollTop = $('#HEX').scrollTop;
	if (hasScrollBar($('#PREVIEW')).horizontal) $('#PREVIEW').scrollLeft = $('#HEX').scrollLeft;
}

$('#HEX').onscroll = () =>{
    
	if (hasScrollBar($('#PREVIEW')).vertical) $('#PREVIEW').scrollTop = $('#HEX').scrollTop;
	if (hasScrollBar($('#PREVIEW')).horizontal) $('#PREVIEW').scrollLeft = $('#HEX').scrollLeft;
}
</script>

<style id="CSS"></style>
<script>
let tempCSS = ``

	const prefixes = ['-','-sm-','-md-','-lg-','-xl-','-xxl-']
	const size = [0,576,768,992,1200,1400]

	prefixes.forEach(function(prefix, resolucion){
		if (resolucion != 0) {tempCSS += '@media(min-width:' + size[resolucion] + 'px){'}
	
		var vIndex = 0
		while(vIndex < 13){
			tempCSS += '.cols'+prefix+vIndex+'{columns:'+vIndex+' auto}'

			vIndex++
		}
		
		[
			['m', 'margin'],
			['mt', 'margin-top'],
			['mb', 'margin-bottom'],
			['ml', 'margin-left'],
			['mr', 'margin-right'],
			['mx', 'margin-block'],
			['my', 'margin-inline'],
			['p', 'padding'],
			['pt', 'padding-top'],
			['pb', 'padding-bottom'],
			['pl', 'padding-left'],
			['pr', 'padding-right'],
			['px', 'padding-block'],
			['py', 'padding-inline'],
			['g', 'gap'],
			['r', 'border-radius']
		].forEach(function(attribute){
			[
				'0',
				'.25rem',
				'.5rem',
				'1rem',
				'1.5rem',
				'3rem'
			].forEach(function(value, index){
				tempCSS += '.' + attribute[0] + prefix + index + '{' + attribute[1]+ ':' + value + '!important}'
			})
		});

		[
			'auto',
			'8.33333333%',
			'16.66666667%',
			'25%',
			'33.33333333%',
			'41.66666667%',
			'50%',
			'58.33333333%',
			'66.66666667%',
			'75%',
			'83.33333333%',
			'91.66666667%',
			'100%'
		].forEach(function(value, index){
			tempCSS += '.col' + prefix + (index == 0 ? 'auto' : ++index) + '{width:' + value + '!important}'
			tempCSS += '.offset' + prefix + (index == 0 ? 'auto' : ++index) + '{margin-left:' + value + '!important}'
		});

		[
			'flex',
			'none',
			'block',
			'inline-block',
			'grid'
		].forEach((value, index) => {
			tempCSS += `.d${prefix}${value} { display : ${value} !important}\n`
		});

		if (resolucion != 0) {tempCSS += '}\n\n'}
	})
$('#CSS').innerHTML = tempCSS

/*
window.onmousemove = (event) => {console.clear()
    console.log(
    	{
    		clientX: event.clientX,
    		clientY: event.clientY,
    		pageX: event.pageX,
    		pageY: event.pageY,
    		offsetX: event.offsetX,
    		offsetY: event.offsetY,
    	}
    )}
*/
</script>
</div>
</body>
</html>